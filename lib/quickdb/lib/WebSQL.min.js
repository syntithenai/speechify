/* WebSQL (v0.2) Paul Sayre */
(function(m){var j=m.WebSQL=function(a,c,b,h,k){var l=m.openDatabase&&m.openDatabase(a,c||"1.0",b||a,h||5E6,k),n=l&&{query:function(b){var a=j.Deferred(),h=e(b)?b:arguments;n.rawTx(function(b){var c=j.Deferred(),g,d,i,f,o,p,k,l=c.reject;f=0;for(o=h.length;f<o;f++)if(g=h[f],d=h[f+1],"function"===typeof g&&(g=g.toString(),g=g.substr(g.indexOf("/*!")+3),g=g.substr(0,g.lastIndexOf("*/"))),(i=/^\s*(?:INSERT|REPLACE)\s+INTO\s+\w+\s*\(([^\)]+)\)\s*$/i.exec(g))&&i[1]&&(g+=" VALUES ("+Array(i[1].split(",").length).join("?,")+
"?)"),e(d))if(f+=1,e(d[0])){i=0;for(p=d.length;i<p;i++)f+1===o&&i+1===p&&(k=c.resolve),b.executeSql(g,d[i],k,l)}else f+1===o&&(k=c.resolve),b.executeSql(g,d,k,l);else f+1===o&&(k=c.resolve),b.executeSql(g,[],k,l);c.fail(a.reject).done(function(b,g){var d=null,f,c;if(g){if(c=g.rows){d=[];for(f=0;f<c.length;f++)d[f]=c.item(f)}if(d&&0===d.length)try{d.insertId=g.insertId}catch(h){d.insertId=null}else d.insertId=null}a.resolve(d)})});return a.promise()},rawTx:function(b){l.transaction(b)},getTableNames:function(){var b=
$.Deferred();n.query('SELECT tbl_name FROM sqlite_master WHERE type = "table" AND tbl_name NOT REGEXP "^(__|sqlite_).*"').fail(b.reject).done(function(c){var a,h=[];for(a=0;a<c.length;a++)h[a]=c[a].tbl_name;b.resolve(h)});return b.promise()},dump:function(b,a){var c=j.Deferred(),a=!1!==a;switch(b){default:n.query('SELECT * FROM sqlite_master WHERE tbl_name NOT REGEXP "^(__|sqlite_).*" ORDER BY CASE type WHEN "table" THEN 1 WHEN "index" THEN 2 ELSE 3 END').fail(c.reject).done(function(b){var h={},
g=[],d,i;for(i=0;d=b[i];i++)if(d.sql)switch(d.type){case "table":h[d.tbl_name]={schema:{table:d.sql,indexes:[]}};a&&function(b){var a=j.Deferred();n.query("SELECT * FROM "+b).fail(a.reject).done(function(c){delete c.insertId;h[b].data=c;a.resolve()});g.push(a)}(d.tbl_name);break;case "index":h[d.tbl_name].schema.indexes.push(d.sql)}j.when.apply(j,g).fail(c.reject).done(function(){c.resolve(h)})});break;case "sql":n.dump("json",a).fail(c.reject).done(function(b){var a=[],h,d,i,f,k,e,l,j;for(j in b)if(Object.prototype.hasOwnProperty.call(b,
j)&&(h=b[j],a.push(h.schema.table),a=a.concat(h.schema.indexes),h.data&&0<h.data.length)){k=[];d=h.data[0];for(f in d)Object.prototype.hasOwnProperty.call(d,f)&&k.push(/\s/.test(f)?"`"+f+"`":f);k=k.join(", ");e=[];for(i=0;d=h.data[i];i++){e[i]=[];for(f in d)Object.prototype.hasOwnProperty.call(d,f)&&(l="number"===typeof d[f]?d[f]:null===d[f]||void 0===d[f]?"NULL":'"'+d[f]+'"',e[i].push(l));e[i]="("+e[i].join(", ")+")"}e=e.join(",\n\t");a.push("INSERT INTO "+j+" ("+k+") VALUES\n\t"+e)}a=a.join(";\n")+
";";c.resolve(a)})}return c.promise()}};return n};j.VERSION="0.2";var e=Array.isArray||function(a){return!!(a&&a.constructor===Array)}})(this);
(function(m){m.Deferred=function(){var e,a=j(),c=j(),b={promise:function(){var a={},c=function(b){return function(){b.apply(this,arguments);return a}};a.always=c(b.always);a.done=c(b.done);a.fail=c(b.fail);a.then=c(b.then);a.state=b.state;return a},state:function(){return e||"pending"},resolve:function(){e||(e="resolved",a.fire.apply(a,arguments));return b},reject:function(){e||(e="rejected",c.fire.apply(c,arguments));return b},always:function(a){return b.then(a,a)},done:function(c){a.add(c);return b},
fail:function(a){c.add(a);return b},then:function(a,c){return b.done(a).fail(c)}};return b};m.when=function(e){var a,c=Array(arguments.length),b=m.Deferred();for(a=0;a<arguments.length;a++)arguments[a].fail(function(){b.reject.apply(this,arguments);c=null});if(0<arguments.length)for(a=0;a<arguments.length;a++)(function(a,e){e.done(function(){c[a]=arguments;for(var e=0;e<c.length&&void 0!==c[e];e++);e===c.length&&b.resolve.apply(b,c)})})(a,arguments[a]);else b.resolve.apply(b,c);return b.promise()};
var j=function(){var e=[],a,c={hasFired:function(){return!!a},add:function(b){e.push(b);c.hasFired()&&c.fire.apply(c,a)},fire:function(){a=arguments;for(var b=0;b<e.length;b++)e[b].apply(c,a);e=[]}};return c}})(WebSQL);
