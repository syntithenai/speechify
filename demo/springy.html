

<script src="../lib/jquery.js" type="text/javascript"></script>
<script src="../jquery.speechify.js" type="text/javascript"></script>
<link rel="stylesheet" href="../jquery.speechify.css" type="text/css" media="all" />
<script>
$.fn.speechify.relPath='../';
</script>
<!-- MINDMAP -->
<script src="springy.js"></script>
<script src="springyui.js"></script>
<script>
	

var graph = new Springy.Graph();
var springy = null;
var mapName = '';

function addSampleDataToGraph(graph) {
	graph.addNodes('Dennis', 'Michael', 'Jessica', 'Timothy', 'Barbara')

	graph.addEdges(
	  ['Dennis', 'Michael', {color: '#00A0B0', label: 'Foo bar'}],
	  ['Michael', 'Dennis', {color: '#6A4A3C'}],
	  ['Michael', 'Jessica', {color: '#CC333F'}],
	  ['Jessica', 'Barbara', {color: '#EB6841'}],
	  ['Michael', 'Timothy', {color: '#EDC951'}],
	  ['Barbara', 'Timothy', {color: '#6A4A3C'}]
	);
}

function saveMap(name) {
	var storeKey = 'springymap_default';
	// explicit name yay
	if (typeof name == "string" && name.length > 0) {
		storeKey = name;
	// have we previously saved ?
	} else if (localStorage.getItem("springymap_active") != null && localStorage.getItem(localStorage.getItem("springymap_active")) != null) {
		storeKey = localStorage.getItem("springymap_active");
	} 
	if (storeKey.length > 0) {
		var store = {nodes: springy.graph.nodes, edges: springy.graph.edges};
		localStorage.setItem(storeKey,JSON.stringify(store));
		localStorage.setItem("springymap_active",storeKey);
	}
}

function loadMap(name) {
	var storeKey = 'springymap_default';
	if (typeof name == "string" && name.length > 0 && localStorage.getItem(name)!=null) {
		storeKey = name;
	} else if (localStorage.getItem("springymap_active") != null && localStorage.getItem(localStorage.getItem("springymap_active")) != null ) {
		storeKey =  localStorage.getItem("springymap_active");
	} 
	var storedGraph = JSON.parse(localStorage.getItem(storeKey));
	console.log(['STORE',storeKey,storedGraph]);
	if (storedGraph != null) 	{
		console.log(['LOADFROMSTORAGE',storedGraph]);
		graph.edges = [];
		graph.nodes = [];
		graph.nodeSet = {};
		for (var i = 0; i < storedGraph.nodes.length; i++) {
			graph.addNode(new Springy.Node(storedGraph.nodes[i].id,storedGraph.nodes[i].data)); //[i]
		}
		for (var i = 0; i < storedGraph.edges.length; i++) {
//			console.log(['create edge',storedGraph.edges[i].id,storedGraph.edges[i].source,storedGraph.edges[i].target,storedGraph.edges[i].data]);
//			console.log(['create edge related',graph.nodeSet[storedGraph.edges[i].source.id],graph.nodeSet[storedGraph.edges[i].source.id],storedGraph.edges[i].data]);
			graph.addEdge(new Springy.Edge(storedGraph.edges[i].id,graph.nodeSet[storedGraph.edges[i].source.id],graph.nodeSet[storedGraph.edges[i].target.id],storedGraph.edges[i].data));
		} 
		localStorage.setItem("springymap_active",storeKey);
	} else {
		addSampleDataToGraph(graph);
	}
	return storedGraph;
}
loadMap();	

jQuery(function(){
	springy = jQuery('#springydemo').springy({
	graph: graph
	});
	$.fn.speechify.relPath='../';

	<!-- END MINDMAP -->
	var grammarTree = [
	/*	[
			[
			'adenoid|adenoids $content',
			'ad|add|insert|create|write [$qty{(a|one|two|to|three|four|five)}] [note|notes|node|nodes] $content [and $content2] [and $content3] [and $content4] [and $content5]'],
			function(params) {
				var variables = params[1];
				var selected = springy.renderer.getSelected();
					
				//console.log(['selected',springy.renderer.getSelected()]);
				// default single
				if (!variables.hasOwnProperty('$qty') || variables['$qty'].length == 0 || variables['$qty'] == 'a' ) {
					variables['$qty'] = 'one';
				}
				// up to five nodes created
				if (variables['$qty'] == 'one'  || variables['$qty'] == 'two' || variables['$qty'] == 'to' || variables['$qty'] == 'three' || variables['$qty'] == 'four' || variables['$qty'] == 'five'  ) {
					graph.addNodes(variables['$content']);
					if ( selected != null && selected.node != null ) {
						graph.addEdges([variables['$content'],selected.node.id])
					}
				}
				if ((variables['$qty'] == 'two' || variables['$qty'] == 'to' || variables['$qty'] == 'three' || variables['$qty'] == 'four' || variables['$qty'] == 'five') && variables.hasOwnProperty('$content2') && typeof variables['$content2'] && variables['$content2'].length>0) {
					graph.addNodes(variables['$content2']);
					if ( selected != null ) {
						graph.addEdges([variables['$content2'],selected.node.id])
					}
				}
				if (( variables['$qty'] == 'three' || variables['$qty'] == 'four' || variables['$qty'] == 'five') && variables.hasOwnProperty('$content3') && typeof variables['$content3'] && variables['$content3'].length>0) {
					graph.addNodes(variables['$content3']);
					if ( selected != null ) {
						graph.addEdges([variables['$content3'],selected.node.id])
					}
				}
				if (( variables['$qty'] == 'four' || variables['$qty'] == 'five') && variables.hasOwnProperty('$content4') && typeof variables['$content4'] && variables['$content4'].length>0) {
					graph.addNodes(variables['$content4']);
					if ( selected != null ) {
						graph.addEdges([variables['$content4'],selected.node.id])
					}
				}
				saveMap();
				springy.renderer.graphChanged();
				jQuery.fn.speechify.notify('Created ' + variables['$qty'] + ' nodes.');
			}
		],*/
		[
			['add [note|node] $content [(to $parentNode|as $connection|to $parentNode as $connection]'],
			function(params) {
				var variables = params[1];
				//var b = springy.graph.findNode(variables['$content']);
				//if (b !=null) {
					//console.log(['select',b]);
					//springy.renderer.setSelected(b);
					//springy.renderer.graphChanged();
				//} else {
					//jQuery.fn.speechify.notify('Couldnt find ' + variables['$content'] + ' to select.');
				//}
				console.log(['add node',variables]);
				jQuery.fn.speechify.notify('jo');
			}
		],
		[
			['select|choose|shoes|cheers|pick|pic [a|the] [note|node] $content'],
			function(params) {
				var variables = params[1];
				var b = springy.graph.findNode(variables['$content']);
				if (b !=null) {
					console.log(['select',b]);
					springy.renderer.setSelected(b);
					springy.renderer.graphChanged();
				} else {
					jQuery.fn.speechify.notify('Couldnt find ' + variables['$content'] + ' to select.');
				}
			}
		],
		[
			['select|choose|shoes|cheers|pick|pic nothing'],
			function(params) {
				console.log(['select nothing']);
				springy.renderer.setSelected(null);
				springy.renderer.graphChanged();
			}
		],
		// START
		[
			['rename $node to $newName'],
			function(params) {
				console.log(['rename node']);
				var variables = params[1];
				var node = springy.graph.findNode(variables['$node']);
				if (node == null) {
					jQuery.fn.speechify.notify("Can't find <b>"+variables['$node']+"</b> to rename.");
				} else {
					node.data.label = variables['$newName'];
					jQuery.fn.speechify.notify("Renamed <b>"+variables['$node']+"</b> to <b>"+variables['$newName']+"</b>");
					saveMap();
					springy.renderer.graphChanged();
				} 
			}
		],
		[
			['prepend $text (to|too|two) (node|note) $node'],
			function(params) {
				console.log(['append text']);
				var variables = params[1];
				var node = springy.graph.findNode(variables['$node']);
				if (node == null) {
					jQuery.fn.speechify.notify("Can't find <b>"+variables['$node']+"</b> to add text.");
				} else {
					node.data.label = variables['$text'] + ' ' + node.data.label;
					jQuery.fn.speechify.notify("Prepended <b>"+variables['$text']+"</b> to <b>"+variables['$node']+"</b>");
					saveMap();
					springy.renderer.graphChanged();
				} 
			}
		],
		[
			['append $text (to|too|two) (node|note) $node'],
			function(params) {
				console.log(['append text']);
				var variables = params[1];
				var node = springy.graph.findNode(variables['$node']);
				if (node == null) {
					jQuery.fn.speechify.notify("Can't find <b>"+variables['$node']+"</b> to add text.");
				} else {
					node.data.label = node.data.label  + ' ' + variables['$text'];
					jQuery.fn.speechify.notify("Appended <b>"+variables['$text']+"</b> to <b>"+variables['$node']+"</b>");
					saveMap();
					springy.renderer.graphChanged();
				} 
			}
		],
		[
			['move [note|node] $node from $src to $target'],
			function(params) {
				console.log(['move']);
				saveMap();
				springy.renderer.graphChanged();
			}
		],
		// END
		[
			['delete [a] [note|node] $content'],
			function(params) {
				var variables = params[1];
				if (variables['$content'] == 'selected node') {
					var s = springy.renderer.getSelected();
					console.log(['start DONE remove selected',s]);
					if (s!=null && s.node && s.node.id !=null ) {
						springy.graph.detachNode(s.node);
						springy.graph.removeNode(s.node);
						console.log(['DONE remove selected',s]);
						jQuery.fn.speechify.notify('Deleted <b>' + s.node.data.label + '.</b>' );
					} else {
						jQuery.fn.speechify.notify('No selected node to delete.' );
					}
				} else {
					var b = springy.graph.findNode(variables['$content']);
					var s = springy.renderer.getSelected();
					console.log(['FOUND for delete',b,s,variables]);
					if (b == null) {
						console.log('Couldnt delete. No match on ' + variables['$content']);
						jQuery.fn.speechify.notify('Couldnt delete. No match on <b>' + variables['$content']+'</b>');
					} else if (s == null) {
						jQuery.fn.speechify.notify('Couldnt delete. Nothing selected');
						console.log('Couldnt delete. Nothing selected');
					} else if (b && b.id  && s.node && s.node.id && (b.id == s.node.id)) {
						springy.graph.detachNode(b);
						springy.graph.removeNode(b);
						console.log(['DONE remove',variables]);
						jQuery.fn.speechify.notify('Deleted <b>' + variables['$content'] + '</b>.' );
					} else {
						console.log('Couldnt delete. <b>' + variables['$content'] + '</b> is not selected.' );
						jQuery.fn.speechify.notify('Couldnt delete. <b>' + variables['$content'] + '</b> must be selected before it can be deleted.' );
					}
				}
				saveMap();
				springy.renderer.graphChanged();
				console.log('done delete note ');
			}
		],
		[
			['join|connect $from to|and $to [as $connection]'],
			function(params) {
				var variables = params[1];
				var from = springy.graph.findNode(variables['$from']);
				var to = springy.graph.findNode(variables['$to']);
				if (from !=null && to !=null) {
					springy.graph.addEdges([from.id,to.id,{label: variables['$connection']}]);
					var connectMessage = "";
					if (variables.hasOwnProperty('$connection') && variables['$connection'].length > 0) {
						connectMessage = " as <b>" + variables['$connection']+"</b>";
					}
					jQuery.fn.speechify.notify('Added connection from <b>' + variables['$from'] + '</b> to <b>' + variables['$to'] + '</b>' +connectMessage+ '.' );
					saveMap();
					springy.renderer.graphChanged();
				} else if (from == null) {
					jQuery.fn.speechify.notify("Couldn't create connection. Can't find <b>"+variables['$from']+"</b>");
				} else if (to == null) {
					jQuery.fn.speechify.notify("Couldn't create connection. Can't find <b>"+variables['$to']+"</b>");
				}
			}
		],
		[
			['(disconnect|break|brake|remove connection) $from to $to [as $connection]'],
			function(params) {
				
				var variables = params[1];
				var from = springy.graph.findNode(variables['$from']);
				var to = springy.graph.findNode(variables['$to']);
				console.log(['remove',from,to]);
				var connection = '';
				var connectionString = '';
				if (variables.hasOwnProperty('$connection')) {
					connection = variables['$connection'];
					connectionString = " as <b>" + variables['$connection']+"</b>";
				}
				if (from == null) {
					jQuery.fn.speechify.notify("Couldn't break connection. Can't find <b>"+variables['$from']+"</b>");
				} else if (to == null) {
					jQuery.fn.speechify.notify("Couldn't break connection. Can't find <b>"+variables['$to']+"</b>");
				} else {
					console.log(['seek edges',variables['$from'],variables['$to'],connection]);
					var edges = springy.graph.findEdges(variables['$from'],variables['$to']);
					var foundEdges = [];
					if (edges != null && edges.length > 0) {
						for (var i = 0;i < edges.length; i++) {
							var edge = edges[i];
							if (connection.length > 0 && edge.data.label == connection) {
								springy.graph.removeEdge(edge);
								foundEdges.push(edge);
							} else if (connection.length == 0 ) {
								springy.graph.removeEdge(edge);
								foundEdges.push(edge);
							}
						}
					}
					if (foundEdges.length > 0) {
						jQuery.fn.speechify.notify("Broke " +foundEdges.length+ " connection(s) matching <b>"+variables['$from']+"</b> to <b>"+variables['$to']+"</b>"+ connectionString);
						saveMap();
						springy.renderer.graphChanged();
					} else {
						jQuery.fn.speechify.notify("No connections to break matching <b>"+variables['$from']+"</b> to <b>"+variables['$to']+"</b>"+ connectionString);
					}
				}
			}
		],
		[
			['reset map to sample data'],
			function(params) {
				console.log('reset demo data');
				//graph = new Springy.Graph();
				addSampleDataToGraph(graph);
				saveMap();
				springy.renderer.graphChanged();
				jQuery.fn.speechify.notify('Map data reset to sample data');
			}
		],
		[
			['what can i say'],
			function(params) {
				console.log(['what can I say']);
				jQuery.fn.speechify.notify("create $thing<br/> select $thing <br/>delete $thing");
			}
		],
		[
			['open|load|road map|mac $mapName'],
			function(params) {
				console.log(['loadMap',params]);
				var variables = params[1];
				if (variables.hasOwnProperty('$mapName')) {
					if (loadMap(variables['$mapName']) != null) {
						jQuery.fn.speechify.notify("Loaded map " +variables['$mapName']);
						springy.renderer.graphChanged();
					} else {
						jQuery.fn.speechify.notify("Couldn't load map " +variables['$mapName']);
					}
				} 
			}
		],
		[
			['save map as $mapName'],
			function(params) {
				console.log(['saveMap',params]);
				var variables = params[1];
				if (variables.hasOwnProperty('$mapName')) {
					//TODO EXISTENCE CHECK
					saveMap(variables['$mapName'])
					jQuery.fn.speechify.notify("Saved map as " + variables['$mapName']);
				} else {
					jQuery.fn.speechify.notify('Cannot save. Missing name');
				}
			}
		],
		[
			['new map [as] $mapName'],
			function(params) {
				console.log(['newMap',params]);
				var variables = params[1];
				if (variables.hasOwnProperty('$mapName') && variables['$mapName'].length >0) {
					graph.edges = [];
					graph.nodes = [];
					graph.nodeSet = {};
					saveMap(variables['$mapName'])
					jQuery.fn.speechify.notify("Saved new map as " + variables['$mapName']);
					springy.renderer.graphChanged();
				} else {
					jQuery.fn.speechify.notify('Cannot save. Missing name');
				}
			}
		],
		[
			['list|show [$trash] maps'],
			function(params) {
				console.log(['list Maps',params]);
				// TODO CONFIRMATION
				var notifyMessage = 'Available maps include <br/><br/>';
				for (var key in localStorage){
					if (key != "springymap_active" && key != "springymap_default") {
						notifyMessage += '<b>' + key + '</b><br/>';
					}
				}
				jQuery.fn.speechify.notify(notifyMessage);
				
			}
		],
		[
			['delete map $mapName now please'],
			function(params) {
				console.log(['delete Map',params]);
				var variables = params[1];
				if (variables.hasOwnProperty('$mapName')) {
					if (localStorage.getItem(variables['$mapName']) != null)  {
						localStorage.removeItem(variables['$mapName']);
						jQuery.fn.speechify.notify('Deleted map '+variables['$mapName']);
					} else {
						jQuery.fn.speechify.notify('Cannot find map '+variables['$mapName'] + ' to delete.' );
					}
				} else {
					jQuery.fn.speechify.notify('Which map do you want to delete ?');
				}
				
			}
		],
		[
			['clear [the] map now please'],
			function(params) {
				console.log(['clear Map',params]);
				// TODO CONFIRMATION
				jQuery.fn.speechify.notify('Cleared the map.');
				graph.edges = [];
				graph.nodes = [];
				graph.nodeSet = {};
				springy.renderer.graphChanged();
			}
		],
		[
			['what|which map|mac (is current|am i using)'],
			function(params) {
				// TODO CONFIRMATION
				jQuery.fn.speechify.notify('Current map is <b>' +localStorage.getItem('springymap_active') + '</b>');
			}
		]
	];
	
	var grammars=[];
	for (i in grammarTree) {
		grammars.push(new SpeechifyGrammar(grammarTree[i][0],grammarTree[i][1]));
	}
	$("#springydemospeech").speechify({
		'grammars' : grammars,
	});
});

	
$(document).ready(function() {

});


</script>
<div id="springydemospeech" ></div>
<canvas id="springydemo" width="640" height="480" />
